name: Build SD Card Image

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version (e.g., 0.1.0)'
        required: true
        default: '0.1.0'

env:
  IMAGE_NAME: momo-shadow
  PI_GEN_RELEASE: bookworm

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
          
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            coreutils quilt parted qemu-user-static debootstrap \
            zerofree zip dosfstools libarchive-tools libcap2-bin \
            grep rsync xz-utils file git curl bc gpg pigz xxd \
            arch-test kpartx
            
      - name: Clone pi-gen
        run: |
          git clone --depth 1 https://github.com/RPi-Distro/pi-gen.git pi-gen
          
      - name: Patch pi-gen for missing packages and services
        run: |
          cd pi-gen
          
          # Find and remove problematic RPi-specific packages
          echo "=== Searching for problematic packages ==="
          
          # List all package files
          find . -name "*packages*" -type f 2>/dev/null | head -20
          
          # Remove specific packages that don't exist in standard repos
          PROBLEM_PACKAGES="rpi-swap rpi-loop-utils rpi-usb-gadget rpi-eeprom rpi-cloud-init-mods rpi-connect rpi-connect-lite rpicam-apps rpi-imager"
          
          for pkg in $PROBLEM_PACKAGES; do
            echo "Removing package: $pkg"
            find . -name "*packages*" -type f -exec grep -l "$pkg" {} \; 2>/dev/null | while read f; do
              echo "  Found in: $f"
              sed -i "/^${pkg}$/d" "$f"
              sed -i "/${pkg}/d" "$f"
            done
          done
          
          # Also remove ALL rpi-* packages (they're RPi-specific and may not exist)
          echo "=== Removing all rpi-* packages ==="
          find . -name "*packages*" -type f | while read f; do
            if grep -q "^rpi-" "$f" 2>/dev/null; then
              echo "Cleaning rpi-* from: $f"
              sed -i '/^rpi-/d' "$f"
            fi
          done
          
          echo "=== Patching scripts for missing services ==="
          
          # Patch 01-run.sh scripts to handle missing services gracefully
          find . -name "01-run.sh" -type f | while read f; do
            echo "Patching: $f"
            # Make systemctl enable commands non-fatal
            sed -i 's/systemctl enable/systemctl enable --no-reload 2>\/dev\/null ||true #/g' "$f"
            # Comment out rpi-resize lines
            sed -i '/rpi-resize/s/^/#DISABLED: /' "$f"
            # Comment out rpi-eeprom lines
            sed -i '/rpi-eeprom/s/^/#DISABLED: /' "$f"
          done
          
          # Also patch any run-chroot scripts
          find . -name "*run-chroot*" -o -name "*run.sh" | while read f; do
            if [ -f "$f" ]; then
              echo "Checking: $f"
              sed -i 's/systemctl enable rpi-resize/true #rpi-resize disabled/g' "$f" 2>/dev/null || true
              sed -i 's/systemctl enable rpi-eeprom/true #rpi-eeprom disabled/g' "$f" 2>/dev/null || true
            fi
          done
          
          echo "=== Verification ==="
          grep -r "rpi-swap\|rpi-loop-utils\|rpi-usb-gadget" . --include="*packages*" || echo "All problematic packages removed"
          grep -rn "rpi-resize" stage2/ || echo "rpi-resize references handled"
          
      - name: Configure pi-gen
        run: |
          cd pi-gen
          
          # Main config - NO leading spaces!
          cat > config << 'ENDCONFIG'
          IMG_NAME=momo-shadow
          RELEASE=bookworm
          DEPLOY_COMPRESSION=xz
          COMPRESSION_LEVEL=6
          LOCALE_DEFAULT=en_US.UTF-8
          TARGET_HOSTNAME=shadow
          KEYBOARD_KEYMAP=us
          KEYBOARD_LAYOUT="English (US)"
          TIMEZONE_DEFAULT=UTC
          FIRST_USER_NAME=pi
          FIRST_USER_PASS=shadow123
          ENABLE_SSH=1
          STAGE_LIST="stage0 stage1 stage2 stage-shadow"
          ENDCONFIG
          
          echo "=== Config file ==="
          cat config
          
      - name: Create Shadow stage
        run: |
          cd pi-gen
          
          # Create stage directory structure
          mkdir -p stage-shadow/00-install-deps
          mkdir -p stage-shadow/01-install-shadow
          mkdir -p stage-shadow/02-configure
          
          # EXPORT_IMAGE - tells pi-gen to export image at this stage
          cat > stage-shadow/EXPORT_IMAGE << 'EOF'
          IMG_SUFFIX="-shadow"
          EOF
          
          # prerun.sh
          cat > stage-shadow/prerun.sh << 'EOF'
          #!/bin/bash -e
          echo "Starting MoMo-Shadow stage..."
          EOF
          chmod +x stage-shadow/prerun.sh
          
          # 00-packages - NO .sh extension, one package per line
          cat > stage-shadow/00-install-deps/00-packages << 'EOF'
          git
          python3-pip
          python3-venv
          python3-dev
          build-essential
          hostapd
          dnsmasq
          aircrack-ng
          tcpdump
          iw
          wireless-tools
          avahi-daemon
          EOF
          
          # 01-run-chroot - NO .sh extension for pi-gen!
          cat > stage-shadow/01-install-shadow/00-run-chroot << 'EOF'
          #!/bin/bash -e

          echo "Installing MoMo-Shadow..."

          # Clone MoMo-Shadow
          if [ ! -d /opt/shadow ]; then
              git clone https://github.com/M0M0Sec/MoMo-Shadow.git /opt/shadow
          fi

          # Create virtual environment
          cd /opt/shadow
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip wheel setuptools
          pip install -e . || echo "pip install failed, continuing..."

          # Create directories
          mkdir -p /etc/shadow
          mkdir -p /var/shadow/data
          mkdir -p /var/shadow/captures

          # Copy config
          if [ -f /opt/shadow/config/shadow.example.yml ]; then
              cp /opt/shadow/config/shadow.example.yml /etc/shadow/config.yml
          fi

          # Install systemd service
          if [ -f /opt/shadow/deploy/shadow.service ]; then
              cp /opt/shadow/deploy/shadow.service /etc/systemd/system/
              systemctl enable shadow.service || true
          fi

          echo "MoMo-Shadow installation complete!"
          EOF
          chmod +x stage-shadow/01-install-shadow/00-run-chroot
          
          # 02-run-chroot - System configuration
          cat > stage-shadow/02-configure/00-run-chroot << 'EOF'
          #!/bin/bash -e

          echo "Configuring system for MoMo-Shadow..."

          # Enable SPI for e-Paper display
          if command -v raspi-config &> /dev/null; then
              raspi-config nonint do_spi 0 || true
          fi

          # Determine boot config location
          if [ -f /boot/firmware/config.txt ]; then
              BOOT_CONFIG="/boot/firmware/config.txt"
              CMDLINE="/boot/firmware/cmdline.txt"
          else
              BOOT_CONFIG="/boot/config.txt"
              CMDLINE="/boot/cmdline.txt"
          fi

          # Enable USB Gadget mode
          if ! grep -q "dtoverlay=dwc2" "$BOOT_CONFIG"; then
              echo "dtoverlay=dwc2" >> "$BOOT_CONFIG"
          fi

          if [ -f "$CMDLINE" ] && ! grep -q "g_ether" "$CMDLINE"; then
              sed -i 's/rootwait/rootwait modules-load=dwc2,g_ether/' "$CMDLINE"
          fi

          # Configure hostapd for Shadow AP
          mkdir -p /etc/hostapd
          cat > /etc/hostapd/hostapd.conf << 'HOSTAPD'
          interface=wlan0
          driver=nl80211
          ssid=Shadow-Setup
          hw_mode=g
          channel=7
          wmm_enabled=0
          macaddr_acl=0
          auth_algs=1
          ignore_broadcast_ssid=0
          wpa=2
          wpa_passphrase=shadowpass123
          wpa_key_mgmt=WPA-PSK
          rsn_pairwise=CCMP
          HOSTAPD

          # Point hostapd to config
          echo 'DAEMON_CONF="/etc/hostapd/hostapd.conf"' > /etc/default/hostapd

          # Configure dnsmasq
          mkdir -p /etc/dnsmasq.d
          cat > /etc/dnsmasq.d/shadow.conf << 'DNSMASQ'
          interface=wlan0
          dhcp-range=192.168.4.2,192.168.4.20,255.255.255.0,24h
          address=/shadow.local/192.168.4.1
          DNSMASQ

          # Static IP for AP mode (dhcpcd)
          if [ -f /etc/dhcpcd.conf ]; then
              if ! grep -q "Shadow AP mode" /etc/dhcpcd.conf; then
                  cat >> /etc/dhcpcd.conf << 'DHCPCD'

          # Shadow AP mode
          interface wlan0
          static ip_address=192.168.4.1/24
          nohook wpa_supplicant
          DHCPCD
              fi
          fi

          # Set hostname
          echo "shadow" > /etc/hostname
          sed -i 's/127.0.1.1.*/127.0.1.1\tshadow/' /etc/hosts || true

          # Disable wpa_supplicant
          systemctl disable wpa_supplicant 2>/dev/null || true

          # Enable services
          systemctl enable hostapd 2>/dev/null || true
          systemctl enable dnsmasq 2>/dev/null || true
          systemctl enable avahi-daemon 2>/dev/null || true
          systemctl enable ssh 2>/dev/null || true

          echo "System configuration complete!"
          EOF
          chmod +x stage-shadow/02-configure/00-run-chroot
          
          echo "=== Stage structure ==="
          find stage-shadow -type f | head -20
          
      - name: Build image
        run: |
          cd pi-gen
          
          # Show config before build
          echo "=== Final config ==="
          cat config
          
          echo "=== Starting build ==="
          sudo ./build.sh -c config
          
      - name: List build outputs
        if: always()
        run: |
          echo "=== Deploy directory ==="
          ls -la pi-gen/deploy/ 2>/dev/null || echo "No deploy directory"
          
          echo "=== Work directory ==="
          ls -la pi-gen/work/ 2>/dev/null | head -20 || echo "No work directory"
          
      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Find and copy the built image
          IMG_FILE=$(find pi-gen/deploy -name "*.img.xz" 2>/dev/null | head -1)
          if [ -n "$IMG_FILE" ]; then
            echo "Found image: $IMG_FILE"
            cp "$IMG_FILE" "release/${{ env.IMAGE_NAME }}-v${{ steps.version.outputs.version }}-pi-zero-2w.img.xz"
          else
            echo "No image found, checking for .img files..."
            find pi-gen/deploy -name "*.img" 2>/dev/null | head -5
          fi
          
          # Create SHA256 checksum
          cd release
          if ls *.img.xz 1>/dev/null 2>&1; then
            sha256sum *.img.xz > SHA256SUMS.txt
          fi
          
          # Create release notes
          cat > RELEASE_NOTES.md << 'EOF'
          # MoMo-Shadow v${{ steps.version.outputs.version }}

          ## ðŸ¥· Stealth WiFi Recon Device

          ### Quick Start
          1. Download the `.img.xz` file
          2. Flash to SD card with [balenaEtcher](https://etcher.balena.io/)
          3. Insert SD card into Pi Zero 2W
          4. Power on
          5. Connect to WiFi: `Shadow-Setup` (password: `shadowpass123`)
          6. Open: http://192.168.4.1

          ### Default Credentials
          - **SSH User:** pi
          - **SSH Password:** shadow123
          - **WiFi AP:** Shadow-Setup
          - **WiFi Password:** shadowpass123
          - **Web UI:** http://192.168.4.1

          ### What's Included
          - Raspberry Pi OS Lite (Bookworm)
          - MoMo-Shadow pre-installed
          - USB Gadget mode enabled
          - WiFi AP auto-configured
          - Systemd service enabled

          ### Verify Download
          ```bash
          sha256sum -c SHA256SUMS.txt
          ```
          EOF
          
          ls -la
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: shadow-image
          path: release/
          retention-days: 30
          
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: MoMo-Shadow ${{ github.ref_name }}
          body_path: release/RELEASE_NOTES.md
          files: |
            release/*.img.xz
            release/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
