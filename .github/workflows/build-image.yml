name: Build SD Card Image

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version (e.g., 0.1.0)'
        required: true
        default: '0.1.0'

env:
  IMAGE_NAME: momo-shadow
  PI_GEN_RELEASE: bookworm

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
          
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y coreutils quilt parted qemu-user-static debootstrap zerofree zip dosfstools libarchive-tools libcap2-bin grep rsync xz-utils file git curl bc gpg pigz xxd arch-test kpartx
            
      - name: Clone pi-gen
        run: git clone --depth 1 https://github.com/RPi-Distro/pi-gen.git pi-gen
          
      - name: Patch pi-gen for missing packages and services
        run: |
          cd pi-gen
          
          echo "=== Removing problematic packages ==="
          PROBLEM_PACKAGES="rpi-swap rpi-loop-utils rpi-usb-gadget rpi-eeprom rpi-cloud-init-mods rpi-connect rpi-connect-lite rpicam-apps rpi-imager"
          
          for pkg in $PROBLEM_PACKAGES; do
            find . -name "*packages*" -type f -exec sed -i "/^${pkg}$/d" {} \; 2>/dev/null || true
            find . -name "*packages*" -type f -exec sed -i "/${pkg}/d" {} \; 2>/dev/null || true
          done
          
          # Remove ALL rpi-* packages
          find . -name "*packages*" -type f -exec sed -i '/^rpi-/d' {} \; 2>/dev/null || true
          
          echo "=== Patching scripts for missing services ==="
          find . -name "*.sh" -type f -exec sed -i 's/systemctl enable rpi-/true #disabled rpi-/g' {} \; 2>/dev/null || true
          find . -name "*.sh" -type f -exec sed -i '/rpi-resize/s/^/#DISABLED: /' {} \; 2>/dev/null || true
          find . -name "*.sh" -type f -exec sed -i '/rpi-eeprom/s/^/#DISABLED: /' {} \; 2>/dev/null || true
          
          echo "=== Verification ==="
          grep -r "rpi-swap\|rpi-loop-utils\|rpi-usb-gadget" . --include="*packages*" || echo "All problematic packages removed"
          
      - name: Configure pi-gen
        run: |
          cd pi-gen
          echo "IMG_NAME=momo-shadow" > config
          echo "RELEASE=bookworm" >> config
          echo "DEPLOY_COMPRESSION=xz" >> config
          echo "COMPRESSION_LEVEL=6" >> config
          echo "LOCALE_DEFAULT=en_US.UTF-8" >> config
          echo "TARGET_HOSTNAME=shadow" >> config
          echo "KEYBOARD_KEYMAP=us" >> config
          echo 'KEYBOARD_LAYOUT="English (US)"' >> config
          echo "TIMEZONE_DEFAULT=UTC" >> config
          echo "FIRST_USER_NAME=pi" >> config
          echo "FIRST_USER_PASS=shadow123" >> config
          echo "ENABLE_SSH=1" >> config
          echo 'STAGE_LIST="stage0 stage1 stage2"' >> config
          echo "=== Config file ===" && cat config
          
      - name: Add Shadow packages to stage2
        run: |
          cd pi-gen
          mkdir -p stage2/05-shadow
          echo "git" > stage2/05-shadow/00-packages
          echo "python3-pip" >> stage2/05-shadow/00-packages
          echo "python3-venv" >> stage2/05-shadow/00-packages
          echo "python3-dev" >> stage2/05-shadow/00-packages
          echo "hostapd" >> stage2/05-shadow/00-packages
          echo "dnsmasq" >> stage2/05-shadow/00-packages
          echo "aircrack-ng" >> stage2/05-shadow/00-packages
          echo "tcpdump" >> stage2/05-shadow/00-packages
          echo "iw" >> stage2/05-shadow/00-packages
          echo "wireless-tools" >> stage2/05-shadow/00-packages
          echo "avahi-daemon" >> stage2/05-shadow/00-packages
          echo "libjpeg-dev" >> stage2/05-shadow/00-packages
          echo "zlib1g-dev" >> stage2/05-shadow/00-packages
          echo "libfreetype6-dev" >> stage2/05-shadow/00-packages
          echo "rfkill" >> stage2/05-shadow/00-packages
          cat stage2/05-shadow/00-packages
          
      - name: Create Shadow install script
        run: |
          cd pi-gen
          cat > stage2/05-shadow/01-run.sh << 'ENDSCRIPT'
          #!/bin/bash -e
          echo "Installing MoMo-Shadow..."
          on_chroot << 'ENDCHROOT'
          git clone https://github.com/M0M0Sec/MoMo-Shadow.git /opt/shadow || echo "Clone failed"
          cd /opt/shadow || exit 0
          python3 -m venv venv || echo "venv failed"
          . venv/bin/activate || true
          pip install --upgrade pip wheel setuptools || true
          pip install -e . || echo "pip install failed"
          mkdir -p /etc/momo-shadow /var/momo-shadow/data /var/momo-shadow/captures
          [ -f /opt/shadow/config/shadow.example.yml ] && cp /opt/shadow/config/shadow.example.yml /etc/momo-shadow/config.yml
          [ -f /opt/shadow/deploy/shadow.service ] && cp /opt/shadow/deploy/shadow.service /etc/systemd/system/ && systemctl enable shadow.service || true
          ENDCHROOT
          echo "MoMo-Shadow installation complete!"
          ENDSCRIPT
          chmod +x stage2/05-shadow/01-run.sh
          
      - name: Create Shadow config script
        run: |
          cd pi-gen
          cat > stage2/05-shadow/02-run.sh << 'ENDSCRIPT'
          #!/bin/bash -e
          echo "Configuring system for MoMo-Shadow..."
          
          # Boot config paths
          if [ -d "${ROOTFS_DIR}/boot/firmware" ]; then
              BOOT_DIR="${ROOTFS_DIR}/boot/firmware"
          else
              BOOT_DIR="${ROOTFS_DIR}/boot"
          fi
          
          # USB Gadget Mode
          echo "" >> "${BOOT_DIR}/config.txt"
          echo "# USB Gadget Mode" >> "${BOOT_DIR}/config.txt"
          echo "dtoverlay=dwc2" >> "${BOOT_DIR}/config.txt"
          echo "# SPI for e-Paper" >> "${BOOT_DIR}/config.txt"
          echo "dtparam=spi=on" >> "${BOOT_DIR}/config.txt"
          
          # cmdline.txt - add modules
          if [ -f "${BOOT_DIR}/cmdline.txt" ]; then
              sed -i 's/rootwait/rootwait modules-load=dwc2,g_ether/' "${BOOT_DIR}/cmdline.txt"
          fi
          
          # SSH enable file
          touch "${BOOT_DIR}/ssh"
          
          on_chroot << 'ENDCHROOT'
          # Modules
          echo "dwc2" >> /etc/modules
          echo "g_ether" >> /etc/modules
          echo "libcomposite" >> /etc/modules
          
          # hostapd config
          mkdir -p /etc/hostapd
          cat > /etc/hostapd/hostapd.conf << 'HOSTAPD'
          interface=wlan0
          driver=nl80211
          ssid=Shadow-Setup
          hw_mode=g
          channel=7
          wmm_enabled=0
          macaddr_acl=0
          auth_algs=1
          ignore_broadcast_ssid=0
          wpa=2
          wpa_passphrase=shadowpass123
          wpa_key_mgmt=WPA-PSK
          rsn_pairwise=CCMP
          HOSTAPD
          
          echo 'DAEMON_CONF="/etc/hostapd/hostapd.conf"' > /etc/default/hostapd
          systemctl unmask hostapd || true
          
          # dnsmasq config
          mkdir -p /etc/dnsmasq.d
          cat > /etc/dnsmasq.d/shadow.conf << 'DNSMASQ'
          interface=wlan0
          dhcp-range=192.168.4.2,192.168.4.20,255.255.255.0,24h
          address=/shadow.local/192.168.4.1
          DNSMASQ
          
          # Static IP for wlan0
          if [ -f /etc/dhcpcd.conf ]; then
              echo "" >> /etc/dhcpcd.conf
              echo "# Shadow AP mode" >> /etc/dhcpcd.conf
              echo "interface wlan0" >> /etc/dhcpcd.conf
              echo "static ip_address=192.168.4.1/24" >> /etc/dhcpcd.conf
              echo "nohook wpa_supplicant" >> /etc/dhcpcd.conf
          fi
          
          # hostapd override
          mkdir -p /etc/systemd/system/hostapd.service.d
          cat > /etc/systemd/system/hostapd.service.d/override.conf << 'OVERRIDE'
          [Unit]
          After=network.target
          [Service]
          ExecStartPre=/bin/sleep 5
          ExecStartPre=-/sbin/rfkill unblock wifi
          OVERRIDE
          
          # AP setup script
          cat > /usr/local/bin/shadow-ap-setup.sh << 'APSCRIPT'
          #!/bin/bash
          rfkill unblock wifi
          for i in {1..30}; do ip link show wlan0 &>/dev/null && break; sleep 1; done
          systemctl stop wpa_supplicant 2>/dev/null || true
          ip link set wlan0 down 2>/dev/null || true
          sleep 1
          ip link set wlan0 up
          systemctl restart hostapd
          systemctl restart dnsmasq
          APSCRIPT
          chmod +x /usr/local/bin/shadow-ap-setup.sh
          
          # AP setup service
          cat > /etc/systemd/system/shadow-ap.service << 'APSERVICE'
          [Unit]
          Description=MoMo-Shadow AP Setup
          After=network-pre.target
          Before=hostapd.service
          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/shadow-ap-setup.sh
          RemainAfterExit=yes
          [Install]
          WantedBy=multi-user.target
          APSERVICE
          
          # Hostname
          echo "shadow" > /etc/hostname
          grep -q "shadow" /etc/hosts || echo "127.0.1.1 shadow" >> /etc/hosts
          
          # Enable/disable services
          systemctl disable wpa_supplicant 2>/dev/null || true
          systemctl mask wpa_supplicant 2>/dev/null || true
          systemctl enable hostapd dnsmasq avahi-daemon ssh shadow-ap.service 2>/dev/null || true
          ENDCHROOT
          
          echo "Configuration complete!"
          ENDSCRIPT
          chmod +x stage2/05-shadow/02-run.sh
          
      - name: Finalize stage2
        run: |
          cd pi-gen
          touch stage2/EXPORT_IMAGE
          ls -la stage2/05-shadow/
          
      - name: Build image
        run: |
          cd pi-gen
          echo "=== Final config ===" && cat config
          echo "=== Starting build ==="
          sudo ./build.sh -c config
          
      - name: List build outputs
        if: always()
        run: |
          echo "=== Deploy directory ==="
          ls -la pi-gen/deploy/ 2>/dev/null || echo "No deploy directory"
          echo "=== Work directory ==="
          ls -la pi-gen/work/ 2>/dev/null | head -20 || echo "No work directory"
          
      - name: Prepare release files
        run: |
          mkdir -p release
          IMG_FILE=$(find pi-gen/deploy -name "*.img.xz" 2>/dev/null | head -1)
          if [ -n "$IMG_FILE" ]; then
            cp "$IMG_FILE" "release/${{ env.IMAGE_NAME }}-v${{ steps.version.outputs.version }}-pi-zero-2w.img.xz"
          fi
          cd release
          [ -f *.img.xz ] && sha256sum *.img.xz > SHA256SUMS.txt || true
          cat > RELEASE_NOTES.md << 'ENDNOTES'
          # MoMo-Shadow
          
          ## Quick Start
          1. Flash to SD card with balenaEtcher
          2. Insert into Pi Zero 2W and power on
          3. Connect to WiFi: Shadow-Setup (password: shadowpass123)
          4. SSH: pi@192.168.4.1 (password: shadow123)
          ENDNOTES
          ls -la
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: shadow-image
          path: release/
          retention-days: 30
          
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: MoMo-Shadow ${{ github.ref_name }}
          body_path: release/RELEASE_NOTES.md
          files: |
            release/*.img.xz
            release/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
