#!/bin/bash -e
#
# Configure system for MoMo-Shadow
#

echo "Configuring system..."

# Enable SPI for e-Paper display
if command -v raspi-config &> /dev/null; then
    raspi-config nonint do_spi 0
fi

# Enable USB Gadget mode for easy access
BOOT_CONFIG="/boot/firmware/config.txt"
if [ ! -f "$BOOT_CONFIG" ]; then
    BOOT_CONFIG="/boot/config.txt"
fi

if ! grep -q "dtoverlay=dwc2" "$BOOT_CONFIG"; then
    echo "dtoverlay=dwc2" >> "$BOOT_CONFIG"
fi

CMDLINE="/boot/firmware/cmdline.txt"
if [ ! -f "$CMDLINE" ]; then
    CMDLINE="/boot/cmdline.txt"
fi

if ! grep -q "g_ether" "$CMDLINE"; then
    sed -i 's/rootwait/rootwait modules-load=dwc2,g_ether/' "$CMDLINE"
fi

# Configure hostapd for Shadow AP
cat > /etc/hostapd/hostapd.conf << 'EOF'
interface=wlan0
driver=nl80211
ssid=Shadow-Setup
hw_mode=g
channel=7
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=shadowpass123
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
EOF

# Point hostapd to config
echo 'DAEMON_CONF="/etc/hostapd/hostapd.conf"' > /etc/default/hostapd

# Configure dnsmasq
cat > /etc/dnsmasq.d/shadow.conf << 'EOF'
interface=wlan0
dhcp-range=192.168.4.2,192.168.4.20,255.255.255.0,24h
address=/shadow.local/192.168.4.1
EOF

# Static IP for AP mode
if [ -f /etc/dhcpcd.conf ]; then
    if ! grep -q "Shadow AP mode" /etc/dhcpcd.conf; then
        cat >> /etc/dhcpcd.conf << 'EOF'

# Shadow AP mode
interface wlan0
static ip_address=192.168.4.1/24
nohook wpa_supplicant
EOF
    fi
fi

# Alternative: NetworkManager static IP (for newer systems)
if [ -d /etc/NetworkManager/system-connections ]; then
    cat > /etc/NetworkManager/system-connections/shadow-ap.nmconnection << 'EOF'
[connection]
id=shadow-ap
type=wifi
interface-name=wlan0
autoconnect=true

[wifi]
mode=ap
ssid=Shadow-Setup

[wifi-security]
key-mgmt=wpa-psk
psk=shadowpass123

[ipv4]
method=shared
address1=192.168.4.1/24

[ipv6]
method=disabled
EOF
    chmod 600 /etc/NetworkManager/system-connections/shadow-ap.nmconnection
fi

# Disable default WiFi management
systemctl disable wpa_supplicant 2>/dev/null || true

# Enable services
systemctl enable hostapd 2>/dev/null || true
systemctl enable dnsmasq 2>/dev/null || true
systemctl enable avahi-daemon 2>/dev/null || true
systemctl enable ssh 2>/dev/null || true

# Set hostname
echo "shadow" > /etc/hostname
sed -i 's/127.0.1.1.*/127.0.1.1\tshadow/' /etc/hosts

echo "System configured successfully!"

