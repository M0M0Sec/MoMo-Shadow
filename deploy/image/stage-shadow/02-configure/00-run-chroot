#!/bin/bash -e
#
# Configure system for MoMo-Shadow
#

echo "Configuring system for MoMo-Shadow..."

# Enable SPI for e-Paper display
if command -v raspi-config &> /dev/null; then
    raspi-config nonint do_spi 0 || true
fi

# Determine boot config location
if [ -f /boot/firmware/config.txt ]; then
    BOOT_CONFIG="/boot/firmware/config.txt"
    CMDLINE="/boot/firmware/cmdline.txt"
else
    BOOT_CONFIG="/boot/config.txt"
    CMDLINE="/boot/cmdline.txt"
fi

# Enable USB Gadget mode
if [ -f "$BOOT_CONFIG" ] && ! grep -q "dtoverlay=dwc2" "$BOOT_CONFIG"; then
    echo "dtoverlay=dwc2" >> "$BOOT_CONFIG"
fi

if [ -f "$CMDLINE" ] && ! grep -q "g_ether" "$CMDLINE"; then
    sed -i 's/rootwait/rootwait modules-load=dwc2,g_ether/' "$CMDLINE"
fi

# Configure hostapd for Shadow AP
mkdir -p /etc/hostapd
cat > /etc/hostapd/hostapd.conf << 'HOSTAPD'
interface=wlan0
driver=nl80211
ssid=Shadow-Setup
hw_mode=g
channel=7
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=shadowpass123
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
HOSTAPD

# Point hostapd to config
echo 'DAEMON_CONF="/etc/hostapd/hostapd.conf"' > /etc/default/hostapd

# Configure dnsmasq
mkdir -p /etc/dnsmasq.d
cat > /etc/dnsmasq.d/shadow.conf << 'DNSMASQ'
interface=wlan0
dhcp-range=192.168.4.2,192.168.4.20,255.255.255.0,24h
address=/shadow.local/192.168.4.1
DNSMASQ

# Static IP for AP mode (dhcpcd)
if [ -f /etc/dhcpcd.conf ]; then
    if ! grep -q "Shadow AP mode" /etc/dhcpcd.conf; then
        cat >> /etc/dhcpcd.conf << 'DHCPCD'

# Shadow AP mode
interface wlan0
static ip_address=192.168.4.1/24
nohook wpa_supplicant
DHCPCD
    fi
fi

# Set hostname
echo "shadow" > /etc/hostname
sed -i 's/127.0.1.1.*/127.0.1.1\tshadow/' /etc/hosts || true

# Disable wpa_supplicant
systemctl disable wpa_supplicant 2>/dev/null || true

# Enable services
systemctl enable hostapd 2>/dev/null || true
systemctl enable dnsmasq 2>/dev/null || true
systemctl enable avahi-daemon 2>/dev/null || true
systemctl enable ssh 2>/dev/null || true

echo "System configuration complete!"
